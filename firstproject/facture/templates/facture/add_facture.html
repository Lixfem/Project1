{% extends 'facture/base.html' %}

{% block content %}
 <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .formset-container { margin-bottom: 20px; }
        .formset-item { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; }
        .formset-item .form-group { margin-bottom: 10px; }
    </style>
<div class="container mt-4">
        <h1>Cr√©er une facture</h1>
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">{{ message }}</div>
            {% endfor %}
        {% endif %}

        <form method="post">
            {% csrf_token %}
            <!-- Formulaire principal -->
            <div class="form-group">
                {{ form.client.label_tag }}
                {{ form.client }}
                {% if form.client.errors %}
                    <div class="text-danger">{{ form.client.errors }}</div>
                {% endif %}
            </div>
            <div class="form-group">
                {{ form.montant_accompte.label_tag }}
                {{ form.montant_accompte }}
                {% if form.montant_accompte.errors %}
                    <div class="text-danger">{{ form.montant_accompte.errors }}</div>
                {% endif %}
            </div>
            <div class="form-group">
                {{ form.tva_rate.label_tag }}
                {{ form.tva_rate }}
                {% if form.tva_rate.errors %}
                    <div class="text-danger">{{ form.tva_rate.errors }}</div>
                {% endif %}
            </div>
            <div class="form-group">
                {{ form.statut.label_tag }}
                {{ form.statut }}
                {% if form.statut.errors %}
                    <div class="text-danger">{{ form.statut.errors }}</div>
                {% endif %}
            </div>
            <div class="form-group">
                {{ form.commentaire.label_tag }}
                {{ form.commentaire }}
                {% if form.commentaire.errors %}
                    <div class="text-danger">{{ form.commentaire.errors }}</div>
                {% endif %}
            </div>

            <!-- Produits -->
            <h3>Produits</h3>
            {{ produit_formset.management_form }}
            <div id="produit-formset" class="formset-container">
                {% for produit_form in produit_formset %}
                    <div class="formset-item">
                        {{ produit_form.nom_produit.label_tag }}
                        {{ produit_form.nom_produit }}
                        {% if produit_form.nom_produit.errors %}
                            <div class="text-danger">{{ produit_form.nom_produit.errors }}</div>
                        {% endif %}

                        {{ produit_form.description_produit.label_tag }}
                        {{ produit_form.description_produit }}
                        {% if produit_form.description_produit.errors %}
                            <div class="text-danger">{{ produit_form.description_produit.errors }}</div>
                        {% endif %}

                        {{ produit_form.prix_unitaire_produit.label_tag }}
                        {{ produit_form.prix_unitaire_produit }}
                        {% if produit_form.prix_unitaire_produit.errors %}
                            <div class="text-danger">{{ produit_form.prix_unitaire_produit.errors }}</div>
                        {% endif %}

                        {{ produit_form.quantity.label_tag }}
                        {{ produit_form.quantity }}
                        {% if produit_form.quantity.errors %}
                            <div class="text-danger">{{ produit_form.quantity.errors }}</div>
                        {% endif %}

                        {{ produit_form.category.label_tag }}
                        {{ produit_form.category }}
                        {% if produit_form.category.errors %}
                            <div class="text-danger">{{ produit_form.category.errors }}</div>
                        {% endif %}

                        {% if produit_form.DELETE %}
                            {{ produit_form.DELETE }}
                            <label><input type="checkbox" name="{{ produit_form.DELETE.name }}" /> Supprimer</label>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>

            <!-- Services -->
            <h3>Services</h3>
            {{ service_formset.management_form }}
            <div id="service-formset" class="formset-container">
                {% for service_form in service_formset %}
                    <div class="formset-item">
                        {{ service_form.nom_service.label_tag }}
                        {{ service_form.nom_service }}
                        {% if service_form.nom_service.errors %}
                            <div class="text-danger">{{ service_form.nom_service.errors }}</div>
                        {% endif %}

                        {{ service_form.description_service.label_tag }}
                        {{ service_form.description_service }}
                        {% if service_form.description_service.errors %}
                            <div class="text-danger">{{ service_form.description_service.errors }}</div>
                        {% endif %}

                        {{ service_form.montant_du_service.label_tag }}
                        {{ service_form.montant_du_service }}
                        {% if service_form.montant_du_service.errors %}
                            <div class="text-danger">{{ service_form.montant_du_service.errors }}</div>
                        {% endif %}

                        {{ service_form.date_prestation_service.label_tag }}
                        {{ service_form.date_prestation_service }}
                        {% if service_form.date_prestation_service.errors %}
                            <div class="text-danger">{{ service_form.date_prestation_service.errors }}</div>
                        {% endif %}

                        {% if service_form.DELETE %}
                            {{ service_form.DELETE }}
                            <label><input type="checkbox" name="{{ service_form.DELETE.name }}" /> Supprimer</label>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>

            <button type="submit" class="btn btn-primary">Enregistrer</button>
        </form>
    </div>

    <!-- Script pour ajout dynamique (optionnel) -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery.formset@1.2.2/jquery.formset.js"></script>
    <script>
        $(document).ready(function() {
            $('#produit-formset').formset({
                prefix: '{{ produit_formset.prefix }}',
                addText: 'Ajouter un produit',
                deleteText: 'Supprimer'
            });
            $('#service-formset').formset({
                prefix: '{{ service_formset.prefix }}',
                addText: 'Ajouter un service',
                deleteText: 'Supprimer'
            });
        });
    </script>
{% endblock %}


