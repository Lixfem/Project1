{% extends 'facture/base.html' %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">Modifier le Devis</h2>

    {% if messages %}
        <div class="alert-container mb-4">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <form method="POST" action="{% url 'modifier-devis' devis_id=devis.id %}" id="devis-form" novalidate>
        {% csrf_token %}
        
        <!-- Client Selection -->
        <div class="mb-4">
            <label for="client" class="form-label fw-bold">Client</label>
            <select class="form-select" id="client" name="client" required>
                <option value="" disabled {% if not devis.clientDevis %}selected{% endif %}>Sélectionner un client</option>
                {% for client in clients %}
                    <option value="{{ client.id }}" {% if devis.clientDevis.id == client.id %}selected{% endif %}>{{ client.nomClient }}</option>
                {% endfor %}
            </select>
            <div class="invalid-feedback">Veuillez sélectionner un client.</div>
        </div>

        <!-- Produits -->
        <div class="mb-4">
            <h4 class="mb-3">Produits</h4>
            <div id="produits-container">
                {% for produit in devis.produit_set.all %}
                <div class="produit-item mb-3 border p-3 rounded">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Nom du Produit</label>
                            <input type="text" class="form-control" name="produits[{{ forloop.counter0 }}][nom]" value="{{ produit.nomProduit }}" >
                            <div class="invalid-feedback">Veuillez entrer un nom de produit.</div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Quantité</label>
                            <input type="number" class="form-control quantity" name="produits[{{ forloop.counter0 }}][quantity]" min="1" value="{{ produit.quantity }}" >
                            <div class="invalid-feedback">Veuillez entrer une quantité valide.</div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Prix Unitaire</label>
                            <input type="number" class="form-control unit-price" name="produits[{{ forloop.counter0 }}][unit_price]" min="0" step="0.01" value="{{ produit.prixUnitaireProduit }}" >
                            <div class="invalid-feedback">Veuillez entrer un prix valide.</div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Total</label>
                            <input type="number" class="form-control total-price" name="produits[{{ forloop.counter0 }}][total_price]" value="{{ produit.get_total }}" readonly>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" class="btn btn-danger remove-produit w-100">Supprimer</button>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="produit-item mb-3 border p-3 rounded">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Nom du Produit</label>
                            <input type="text" class="form-control" name="produits[0][nom]" >
                            <div class="invalid-feedback">Veuillez entrer un nom de produit.</div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Quantité</label>
                            <input type="number" class="form-control quantity" name="produits[0][quantity]" min="1" >
                            <div class="invalid-feedback">Veuillez entrer une quantité valide.</div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Prix Unitaire</label>
                            <input type="number" class="form-control unit-price" name="produits[0][unit_price]" min="0" step="0.01" >
                            <div class="invalid-feedback">Veuillez entrer un prix valide.</div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Total</label>
                            <input type="number" class="form-control total-price" name="produits[0][total_price]" readonly>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" class="btn btn-danger remove-produit w-100">Supprimer</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <button type="button" class="btn btn-primary mt-2" id="add-produit">Ajouter un Produit</button>
        </div>

        <!-- Services -->
        <div class="mb-4">
            <h4 class="mb-3">Services</h4>
            <div id="services-container">
                {% for service in devis.service_set.all %}
                <div class="service-item mb-3 border p-3 rounded">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Nom du Service</label>
                            <input type="text" class="form-control" name="services[{{ forloop.counter0 }}][nom]" value="{{ service.nomService }}" >
                            <div class="invalid-feedback">Veuillez entrer un nom de service.</div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Montant</label>
                            <input type="number" class="form-control service-price" name="services[{{ forloop.counter0 }}][montant]" min="0" step="0.01" value="{{ service.montantDuService }}" >
                            <div class="invalid-feedback">Veuillez entrer un montant valide.</div>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" class="btn btn-danger remove-service w-100">Supprimer</button>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="service-item mb-3 border p-3 rounded">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Nom du Service</label>
                            <input type="text" class="form-control" name="services[0][nom]" >
                            <div class="invalid-feedback">Veuillez entrer un nom de service.</div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Montant</label>
                            <input type="number" class="form-control service-price" name="services[0][montant]" min="0" step="0.01" >
                            <div class="invalid-feedback">Veuillez entrer un montant valide.</div>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" class="btn btn-danger remove-service w-100">Supprimer</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <button type="button" class="btn btn-primary mt-2" id="add-service">Ajouter un Service</button>
        </div>

        <!-- Total Général -->
        <div class="mb-4">
            <label for="total_general" class="form-label fw-bold">Total Général</label>
            <input type="number" class="form-control" id="total_general" name="total_general" value="{{ devis.totalDevis|floatformat:2 }}" readonly>
        </div>

        <!-- Statut Facture -->
        <div class="mb-4">
            <label for="statut_devis" class="form-label fw-bold">Statut du Devis</label>
            <select name="statut_devis" class="form-select" id="statut_devis" required>
                <option value="" disabled {% if not devis.statutDevis %}selected{% endif %}>Sélectionner un statut</option>
                <option value="1" {% if devis.statutDevis == 1 %}selected{% endif %}>En Attente</option>
                <option value="2" {% if devis.statutDevis == 2 %}selected{% endif %}>Accepté</option>
                <option value="3" {% if devis.statutDevis == 3 %}selected{% endif %}>Refusé</option>
            </select>
            <div class="invalid-feedback">Veuillez sélectionner un statut.</div>
        </div>

        <!-- Commentaire -->
        <div class="mb-4">
            <label for="commentaiDevis" class="form-label fw-bold">Commentaires</label>
            <textarea class="form-control" id="commentaireDevis" name="commentaireDevis" rows="4">{{ devis.commentaireDevis|default:"" }}</textarea>
        </div>

        <!-- Submit Button -->
        <div class="d-flex justify-content-end">
            <button type="submit" class="btn btn-success">Enregistrer les modifications</button>
        </div>
    </form>
</div>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    let produitIndex = {{ devis.produit_set.all|length|default:0 }};
    let serviceIndex = {{ devis.service_set.all|length|default:0 }};

    // Form validation
    const form = document.getElementById('devis-form'); // Fixed ID
    form.addEventListener('submit', (e) => {
        if (!form.checkValidity()) {
            e.preventDefault();
            e.stopPropagation();
        }
        form.classList.add('was-validated');
    });

    // Re-index form inputs
    function reindexItems(container, prefix) {
        const items = container.querySelectorAll(`.${prefix}-item`);
        items.forEach((item, index) => {
            item.querySelectorAll('input').forEach(input => {
                const name = input.name.replace(/\[\d+\]/, `[${index}]`);
                input.name = name;
            });
        });
        return items.length;
    }

    // Add Product
    document.getElementById('add-produit').addEventListener('click', () => {
        const container = document.getElementById('produits-container');
        const produitItem = document.createElement('div');
        produitItem.classList.add('produit-item', 'mb-3', 'border', 'p-3', 'rounded');
        produitItem.innerHTML = `
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Nom du Produit</label>
                    <input type="text" class="form-control" name="produits[${produitIndex}][nom]" required>
                    <div class="invalid-feedback">Veuillez entrer un nom de produit.</div>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Quantité</label>
                    <input type="number" class="form-control quantity" name="produits[${produitIndex}][quantity]" min="1" required>
                    <div class="invalid-feedback">Veuillez entrer une quantité valide.</div>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Prix Unitaire</label>
                    <input type="number" class="form-control unit-price" name="produits[${produitIndex}][unit_price]" min="0" step="0.01" required>
                    <div class="invalid-feedback">Veuillez entrer un prix valide.</div>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Total</label>
                    <input type="number" class="form-control total-price" name="produits[${produitIndex}][total_price]" readonly>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-danger remove-produit w-100">Supprimer</button>
                </div>
            </div>`;
        container.appendChild(produitItem);
        produitIndex++;
        attachEventListeners();
        updateTotalGeneral();
    });

    // Add Service
    document.getElementById('add-service').addEventListener('click', () => {
        const container = document.getElementById('services-container');
        const serviceItem = document.createElement('div');
        serviceItem.classList.add('service-item', 'mb-3', 'border', 'p-3', 'rounded');
        serviceItem.innerHTML = `
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Nom du Service</label>
                    <input type="text" class="form-control" name="services[${serviceIndex}][nom]" required>
                    <div class="invalid-feedback">Veuillez entrer un nom de service.</div>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Montant</label>
                    <input type="number" class="form-control service-price" name="services[${serviceIndex}][montant]" min="0" step="0.01" required>
                    <div class="invalid-feedback">Veuillez entrer un montant valide.</div>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-danger remove-service w-100">Supprimer</button>
                </div>
            </div>`;
        container.appendChild(serviceItem);
        serviceIndex++;
        attachEventListeners();
        updateTotalGeneral();
    });

    // Attach Event Listeners
    function attachEventListeners() {
        // Remove Product
        document.querySelectorAll('.remove-produit').forEach(button => {
            button.removeEventListener('click', removeProduitHandler);
            button.addEventListener('click', removeProduitHandler);
        });

        // Remove Service
        document.querySelectorAll('.remove-service').forEach(button => {
            button.removeEventListener('click', removeServiceHandler);
            button.addEventListener('click', removeServiceHandler);
        });

        // Update Product Totals
        document.querySelectorAll('.produit-item').forEach(item => {
            const quantityInput = item.querySelector('.quantity');
            const unitPriceInput = item.querySelector('.unit-price');
            const totalPriceInput = item.querySelector('.total-price');

            const updateProductTotal = () => {
                const quantity = parseFloat(quantityInput.value) || 0;
                const unitPrice = parseFloat(unitPriceInput.value) || 0;
                if (quantity < 1 || unitPrice < 0) {
                    quantityInput.classList.add('is-invalid');
                    unitPriceInput.classList.add('is-invalid');
                    return;
                }
                const total = quantity * unitPrice;
                totalPriceInput.value = total.toFixed(2);
                updateTotalGeneral();
            };

            quantityInput.removeEventListener('input', updateProductTotal);
            unitPriceInput.removeEventListener('input', updateProductTotal);
            quantityInput.addEventListener('input', updateProductTotal);
            unitPriceInput.addEventListener('input', updateProductTotal);
        });

        // Update Total on Service Price Change
        document.querySelectorAll('.service-price').forEach(input => {
            input.removeEventListener('input', updateTotalGeneral);
            input.addEventListener('input', () => {
                if (parseFloat(input.value) < 0) {
                    input.classList.add('is-invalid');
                    return;
                }
                updateTotalGeneral();
            });
        });
    }

    // Remove Handlers
    function removeProduitHandler() {
        this.closest('.produit-item').remove();
        produitIndex = reindexItems(document.getElementById('produits-container'), 'produit');
        updateTotalGeneral();
    }

    function removeServiceHandler() {
        this.closest('.service-item').remove();
        serviceIndex = reindexItems(document.getElementById('services-container'), 'service');
        updateTotalGeneral();
    }

    // Calculate Total General
    function updateTotalGeneral() {
        let totalGeneral = 0;

        document.querySelectorAll('.total-price').forEach(input => {
            totalGeneral += parseFloat(input.value) || 0;
        });

        document.querySelectorAll('.service-price').forEach(input => {
            totalGeneral += parseFloat(input.value) || 0;
        });

        document.getElementById('total_general').value = totalGeneral.toFixed(2);
    }

    // Initialize
    attachEventListeners();
    updateTotalGeneral();
});
</script>
{% endblock %}