{% extends 'facture/base.html' %}

{% block content %}
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="fas fa-edit me-2"></i>
            Modifier la Facture {{ facture.numero }}
        </h2>
        <div>
            <a href="{% url 'document-detail' document_id=facture.id document_type='facture' %}" 
               class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Retour
            </a>
        </div>
    </div>

    {% if messages %}
        <div class="alert-container">
            {% for message in messages %}
                <div class="alert alert-{% if message.tags == 'success' %}success{% else %}danger{% endif %} alert-dismissible fade show" role="alert">
                    <i class="fas fa-{% if message.tags == 'success' %}check-circle{% else %}exclamation-circle{% endif %} me-2"></i>
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Informations du devis d'origine -->
    {% if facture.devis_origine %}
    <div class="alert alert-info">
        <i class="fas fa-file-alt me-2"></i>
        <strong>Facture générée depuis le devis :</strong> 
        <a href="{% url 'document-detail' document_id=facture.devis_origine.id document_type='devis' %}" 
           class="alert-link">
            {{ facture.devis_origine.numero }}
        </a>
    </div>
    {% endif %}

    <form method="POST" id="factureForm">
        {% csrf_token %}
        
        <!-- Informations de la Facture -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informations de la Facture</h5>
            </div>
            <div class="card-body">
                {{ form.non_field_errors }}
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.client.id_for_label }}" class="form-label">
                            <i class="fas fa-user me-1"></i>Client <span class="text-danger">*</span>
                        </label>
                        {{ form.client }}
                        {{ form.client.errors }}
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="{{ form.statut.id_for_label }}" class="form-label">
                            <i class="fas fa-flag me-1"></i>Statut
                        </label>
                        {{ form.statut }}
                        {{ form.statut.errors }}
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="{{ form.taux_tva.id_for_label }}" class="form-label">
                            <i class="fas fa-percent me-1"></i>Taux de TVA (%)
                        </label>
                        {{ form.taux_tva }}
                        <small class="form-text text-muted">Par défaut: 18%</small>
                        {{ form.taux_tva.errors }}
                    </div>

                    <div class="col-md-4 mb-3">
                        <label for="{{ form.montant_accompte.id_for_label }}" class="form-label">
                            <i class="fas fa-money-bill me-1"></i>Montant Accompte
                        </label>
                        {{ form.montant_accompte }}
                        {{ form.montant_accompte.errors }}
                    </div>

                    <div class="col-md-4 mb-3">
                        <label class="form-label">
                            <i class="fas fa-wallet me-1"></i>Solde dû
                        </label>
                        <input type="text" class="form-control" 
                               value="{{ facture.solde_du|floatformat:2 }} FCFA" 
                               readonly>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="{{ form.commentaire.id_for_label }}" class="form-label">
                        <i class="fas fa-comment me-1"></i>Commentaires
                    </label>
                    {{ form.commentaire }}
                    {{ form.commentaire.errors }}
                </div>
            </div>
        </div>

        <!-- Produits Formset -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-box me-2"></i>Produits</h5>
            </div>
            <div class="card-body">
                {{ produit_formset.management_form }}
                <div id="produits-container">
                    {% for produit_form in produit_formset %}
                        <div class="produit-item mb-3 p-3 border rounded" data-form-index="{{ forloop.counter0 }}">
                            {{ produit_form.non_field_errors }}
                            
                            <!-- Champ caché pour le ForeignKey -->
                            <div style="display:none;">
                                {{ produit_form.id }}
                                {{ produit_form.produit }}
                            </div>
                            
                            <div class="row">
                                <div class="col-md-3 position-relative">
                                    <label for="{{ produit_form.nom_produit.id_for_label }}" class="form-label">
                                        Nom du Produit <span class="text-danger">*</span>
                                    </label>
                                    {{ produit_form.nom_produit }}
                                    <ul class="list-group suggestions position-absolute w-100" style="display:none; z-index:1000;"></ul>
                                    <small class="form-text text-muted">Tapez au moins 2 caractères pour rechercher</small>
                                    {{ produit_form.nom_produit.errors }}
                                </div>
                                
                                <div class="col-md-3">
                                    <label for="{{ produit_form.description_produit.id_for_label }}" class="form-label">Description</label>
                                    {{ produit_form.description_produit }}
                                    {{ produit_form.description_produit.errors }}
                                </div>
                                
                                <div class="col-md-2">
                                    <label for="{{ produit_form.quantite.id_for_label }}" class="form-label">Qté</label>
                                    {{ produit_form.quantite }}
                                    {{ produit_form.quantite.errors }}
                                </div>
                                
                                <div class="col-md-2">
                                    <label for="{{ produit_form.prix_unitaire_produit.id_for_label }}" class="form-label">Prix Unit.</label>
                                    {{ produit_form.prix_unitaire_produit }}
                                    {{ produit_form.prix_unitaire_produit.errors }}
                                </div>

                                <div class="col-md-2">
                                    <label class="form-label">Remise (%)</label>
                                    {{ produit_form.remise }}
                                    {{ produit_form.remise.errors }}
                                </div>
                            </div>
                            
                            <div class="row mt-2">
                                <div class="col-md-2">
                                    <label for="total_price_{{ forloop.counter0 }}" class="form-label">Total</label>
                                    <input type="number" class="form-control total-price bg-light" 
                                           id="total_price_{{ forloop.counter0 }}" readonly>
                                </div>
                                
                                <div class="col-md-10 d-flex justify-content-end align-items-end gap-2">
                                    {% if forloop.first %}
                                        <button type="button" class="btn btn-sm btn-danger remove-produit" disabled>
                                            <i class="fas fa-trash me-1"></i>Supprimer
                                        </button>
                                    {% else %}
                                        <button type="button" class="btn btn-sm btn-danger remove-produit">
                                            <i class="fas fa-trash me-1"></i>Supprimer
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Hidden DELETE field -->
                            {{ produit_form.DELETE }}
                        </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-success" id="add-produit">
                    <i class="fas fa-plus me-2"></i>Ajouter un Produit
                </button>
            </div>
        </div>

        <!-- Services Formset -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-concierge-bell me-2"></i>Services</h5>
            </div>
            <div class="card-body">
                {{ service_formset.management_form }}
                <div id="services-container">
                    {% for service_form in service_formset %}
                        <div class="service-item mb-3 p-3 border rounded" data-form-index="{{ forloop.counter0 }}">
                            {{ service_form.non_field_errors }}
                            
                            <!-- Champ caché pour le ForeignKey -->
                            <div style="display:none;">
                                {{ service_form.id }}
                                {{ service_form.service }}
                            </div>
                            
                            <div class="row">
                                <div class="col-md-3 position-relative">
                                    <label for="{{ service_form.nom_service.id_for_label }}" class="form-label">
                                        Nom du Service <span class="text-danger">*</span>
                                    </label>
                                    {{ service_form.nom_service }}
                                    <ul class="list-group suggestions position-absolute w-100" style="display:none; z-index:1000;"></ul>
                                    <small class="form-text text-muted">Tapez au moins 2 caractères pour rechercher</small>
                                    {{ service_form.nom_service.errors }}
                                </div>
                                
                                <div class="col-md-4">
                                    <label for="{{ service_form.description_service.id_for_label }}" class="form-label">Description</label>
                                    {{ service_form.description_service }}
                                    {{ service_form.description_service.errors }}
                                </div>
                                
                                <div class="col-md-2">
                                    <label for="{{ service_form.montant_du_service.id_for_label }}" class="form-label">Montant</label>
                                    {{ service_form.montant_du_service }}
                                    {{ service_form.montant_du_service.errors }}
                                </div>
                                
                                <div class="col-md-3">
                                    <label for="{{ service_form.date_prestation_service.id_for_label }}" class="form-label">Date Prestation</label>
                                    {{ service_form.date_prestation_service }}
                                    {{ service_form.date_prestation_service.errors }}
                                </div>
                            </div>
                            
                            <div class="row mt-2">
                                <div class="col-12 d-flex justify-content-end gap-2">
                                    {% if forloop.first %}
                                        <button type="button" class="btn btn-sm btn-danger remove-service" disabled>
                                            <i class="fas fa-trash me-1"></i>Supprimer
                                        </button>
                                    {% else %}
                                        <button type="button" class="btn btn-sm btn-danger remove-service">
                                            <i class="fas fa-trash me-1"></i>Supprimer
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Hidden DELETE field -->
                            {{ service_form.DELETE }}
                        </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-info" id="add-service">
                    <i class="fas fa-plus me-2"></i>Ajouter un Service
                </button>
            </div>
        </div>

        <!-- Total Général -->
        <div class="card mb-4">
            <div class="card-body bg-light">
                <div class="row">
                    <div class="col-md-6 offset-md-6">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>Total HT:</strong>
                            <span id="total_ht" class="fs-5">{{ facture.total_net_ht|floatformat:2 }} FCFA</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>TVA ({{ facture.taux_tva }}%):</strong>
                            <span id="total_tva" class="fs-5">{{ facture.total_tva|floatformat:2 }} FCFA</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center border-top pt-2">
                            <strong class="fs-4">Total TTC:</strong>
                            <span id="total_general" class="fs-4 text-primary fw-bold">{{ facture.total_ttc|floatformat:2 }} FCFA</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Buttons -->
        <div class="d-flex justify-content-end gap-2 mb-4">
            <a href="{% url 'document-detail' document_id=facture.id document_type='facture' %}" 
               class="btn btn-secondary">
                <i class="fas fa-times me-2"></i>Annuler
            </a>
            <button type="submit" class="btn btn-success">
                <i class="fas fa-save me-2"></i>Enregistrer les modifications
            </button>
        </div>
    </form>
</div>

<style>
    .suggestions {
        background: white;
        border: 1px solid #ddd;
        border-radius: 0.25rem;
        max-height: 250px;
        overflow-y: auto;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .suggestions li {
        cursor: pointer;
        padding: 0.5rem 1rem;
        border-bottom: 1px solid #f0f0f0;
    }
    .suggestions li:hover {
        background-color: #f8f9fa;
    }
    .suggestions li:last-child {
        border-bottom: none;
    }
    .produit-item, .service-item {
        background-color: #f8f9fa;
        transition: all 0.3s ease;
    }
    .produit-item:hover, .service-item:hover {
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
    let produitIndex = {{ produit_formset.total_form_count }};
    let serviceIndex = {{ service_formset.total_form_count }};

    const searchProduitsUrl = "{% url 'search-produits' %}";
    const searchServicesUrl = "{% url 'search-services' %}";

    const produitTemplate = document.querySelector('.produit-item') ? document.querySelector('.produit-item').cloneNode(true) : null;
    const serviceTemplate = document.querySelector('.service-item') ? document.querySelector('.service-item').cloneNode(true) : null;

    const debounce = (func, delay) => {
        let timeout;
        return (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => func(...args), delay);
        };
    };

    // Add Product
    document.getElementById('add-produit').addEventListener('click', function () {
        if (!produitTemplate) return;
        
        const container = document.getElementById('produits-container');
        const newProduit = produitTemplate.cloneNode(true);
        newProduit.dataset.formIndex = produitIndex;

        newProduit.querySelectorAll('input, select, textarea').forEach(input => {
            if (input.name && !input.classList.contains('total-price')) {
                input.name = input.name.replace(/produits-\d+-/, `produits-${produitIndex}-`);
                input.id = input.id.replace(/id_produits-\d+-/, `id_produits-${produitIndex}-`);
                input.value = input.type === 'number' && input.name.includes('quantite') ? '1' : '';
            }
        });

        newProduit.querySelectorAll('label').forEach(label => {
            if (label.htmlFor) {
                label.htmlFor = label.htmlFor.replace(/id_produits-\d+-/, `id_produits-${produitIndex}-`);
            }
        });

        const totalPriceInput = newProduit.querySelector('.total-price');
        totalPriceInput.id = `total_price_${produitIndex}`;
        totalPriceInput.value = '0.00';

        const removeButton = newProduit.querySelector('.remove-produit');
        removeButton.disabled = false;

        container.appendChild(newProduit);

        const totalFormsInput = document.querySelector('input[name="produits-TOTAL_FORMS"]');
        if (totalFormsInput) {
            totalFormsInput.value = parseInt(totalFormsInput.value) + 1;
        }

        produitIndex++;
        attachEventListeners();
        updateTotalGeneral();
    });

    // Add Service
    document.getElementById('add-service').addEventListener('click', function () {
        if (!serviceTemplate) return;
        
        const container = document.getElementById('services-container');
        const newService = serviceTemplate.cloneNode(true);
        newService.dataset.formIndex = serviceIndex;

        newService.querySelectorAll('input, select, textarea').forEach(input => {
            if (input.name) {
                input.name = input.name.replace(/services-\d+-/, `services-${serviceIndex}-`);
                input.id = input.id.replace(/id_services-\d+-/, `id_services-${serviceIndex}-`);
                input.value = '';
            }
        });

        newService.querySelectorAll('label').forEach(label => {
            if (label.htmlFor) {
                label.htmlFor = label.htmlFor.replace(/id_services-\d+-/, `id_services-${serviceIndex}-`);
            }
        });

        const removeButton = newService.querySelector('.remove-service');
        removeButton.disabled = false;

        container.appendChild(newService);

        const totalFormsInput = document.querySelector('input[name="services-TOTAL_FORMS"]');
        if (totalFormsInput) {
            totalFormsInput.value = parseInt(totalFormsInput.value) + 1;
        }

        serviceIndex++;
        attachEventListeners();
        updateTotalGeneral();
    });

    function attachEventListeners() {
        // Remove handlers
        document.querySelectorAll('.remove-produit').forEach(button => {
            button.onclick = function() {
                const item = this.closest('.produit-item');
                const deleteInput = item.querySelector('input[name$="-DELETE"]');
                if (deleteInput) {
                    deleteInput.value = 'on';
                    item.style.display = 'none';
                } else {
                    item.remove();
                }
                updateTotalGeneral();
            };
        });

        document.querySelectorAll('.remove-service').forEach(button => {
            button.onclick = function() {
                const item = this.closest('.service-item');
                const deleteInput = item.querySelector('input[name$="-DELETE"]');
                if (deleteInput) {
                    deleteInput.value = 'on';
                    item.style.display = 'none';
                } else {
                    item.remove();
                }
                updateTotalGeneral();
            };
        });

        // Product calculations
        document.querySelectorAll('.produit-item').forEach(item => {
            if (item.style.display !== 'none') {
                const qtyInput = item.querySelector('input[name$="quantite"]');
                const priceInput = item.querySelector('input[name$="prix_unitaire_produit"]');
                const remiseInput = item.querySelector('input[name$="remise"]');
                const totalInput = item.querySelector('.total-price');

                if (qtyInput && priceInput && totalInput) {
                    const updateTotal = () => {
                        const qty = parseFloat(qtyInput.value) || 0;
                        const price = parseFloat(priceInput.value) || 0;
                        const remise = parseFloat(remiseInput?.value) || 0;
                        const total = qty * price * (1 - remise / 100);
                        totalInput.value = total.toFixed(2);
                        updateTotalGeneral();
                    };

                    if (!qtyInput.dataset.listenerAttached) {
                        qtyInput.addEventListener('input', updateTotal);
                        qtyInput.dataset.listenerAttached = 'true';
                    }
                    
                    if (!priceInput.dataset.listenerAttached) {
                        priceInput.addEventListener('input', updateTotal);
                        priceInput.dataset.listenerAttached = 'true';
                    }
                    
                    if (remiseInput && !remiseInput.dataset.listenerAttached) {
                        remiseInput.addEventListener('input', updateTotal);
                        remiseInput.dataset.listenerAttached = 'true';
                    }
                    
                    updateTotal();
                }
            }
        });

        // Service calculations
        document.querySelectorAll('.service-item').forEach(item => {
            if (item.style.display !== 'none') {
                const montantInput = item.querySelector('input[name$="montant_du_service"]');
                if (montantInput && !montantInput.dataset.listenerAttached) {
                    montantInput.addEventListener('input', updateTotalGeneral);
                    montantInput.dataset.listenerAttached = 'true';
                }
            }
        });

        // Listener pour le taux de TVA
        const tvaInput = document.querySelector('input[name="taux_tva"]');
        if (tvaInput && !tvaInput.dataset.listenerAttached) {
            tvaInput.addEventListener('input', updateTotalGeneral);
            tvaInput.dataset.listenerAttached = 'true';
        }
    }

    function updateTotalGeneral() {
        let totalHT = 0;

        // Produits
        document.querySelectorAll('.produit-item').forEach(item => {
            if (item.style.display !== 'none') {
                const deleteInput = item.querySelector('input[name$="-DELETE"]');
                if (!deleteInput || deleteInput.value !== 'on') {
                    const qtyInput = item.querySelector('input[name$="quantite"]');
                    const priceInput = item.querySelector('input[name$="prix_unitaire_produit"]');
                    const remiseInput = item.querySelector('input[name$="remise"]');
                    
                    if (qtyInput && priceInput) {
                        const qty = parseFloat(qtyInput.value) || 0;
                        const price = parseFloat(priceInput.value) || 0;
                        const remise = parseFloat(remiseInput?.value) || 0;
                        totalHT += qty * price * (1 - remise / 100);
                    }
                }
            }
        });

        // Services
        document.querySelectorAll('.service-item').forEach(item => {
            if (item.style.display !== 'none') {
                const deleteInput = item.querySelector('input[name$="-DELETE"]');
                if (!deleteInput || deleteInput.value !== 'on') {
                    const montantInput = item.querySelector('input[name$="montant_du_service"]');
                    const montant = montantInput ? parseFloat(montantInput.value) || 0 : 0;
                    totalHT += montant;
                }
            }
        });

        // TVA
        const tvaInput = document.querySelector('input[name="taux_tva"]');
        const tvaRate = tvaInput ? parseFloat(tvaInput.value) || 18 : 18;
        const totalTVA = totalHT * (tvaRate / 100);
        const totalTTC = totalHT + totalTVA;

        document.getElementById('total_ht').textContent = totalHT.toFixed(2) + ' FCFA';
        document.getElementById('total_tva').textContent = totalTVA.toFixed(2) + ' FCFA';
        document.getElementById('total_general').textContent = totalTTC.toFixed(2) + ' FCFA';
    }

    // Initialize
    attachEventListeners();
    updateTotalGeneral();
});
</script>
{% endblock %}